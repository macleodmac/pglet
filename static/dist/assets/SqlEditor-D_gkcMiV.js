import{q as I,r as m,f as S,p as b,u as y,j as h}from"./index-CFLSYYBi.js";import{F as L}from"./index-63m5aII2.js";const k=["SELECT","FROM","WHERE","AND","OR","NOT","IN","IS","NULL","AS","JOIN","LEFT","RIGHT","INNER","OUTER","FULL","CROSS","ON","INSERT","INTO","VALUES","UPDATE","SET","DELETE","CREATE","ALTER","DROP","TABLE","INDEX","VIEW","SCHEMA","GROUP","BY","ORDER","ASC","DESC","LIMIT","OFFSET","HAVING","DISTINCT","UNION","ALL","INTERSECT","EXCEPT","EXISTS","BETWEEN","LIKE","ILIKE","SIMILAR","TO","CASE","WHEN","THEN","ELSE","END","CAST","COALESCE","NULLIF","GREATEST","LEAST","COUNT","SUM","AVG","MIN","MAX","ARRAY_AGG","STRING_AGG","NOW","CURRENT_TIMESTAMP","CURRENT_DATE","CURRENT_TIME","TRUE","FALSE","DEFAULT","PRIMARY","KEY","FOREIGN","REFERENCES","UNIQUE","CHECK","CONSTRAINT","WITH","RECURSIVE","RETURNING","EXPLAIN","ANALYZE","VERBOSE","BEGIN","COMMIT","ROLLBACK","SAVEPOINT","GRANT","REVOKE","TRIGGER","FUNCTION","PROCEDURE","RETURNS","LANGUAGE","IF","ELSIF","LOOP","FOR","WHILE","DECLARE","TEXT","INTEGER","BIGINT","SMALLINT","BOOLEAN","VARCHAR","CHAR","NUMERIC","DECIMAL","REAL","DOUBLE","PRECISION","SERIAL","BIGSERIAL","TIMESTAMP","DATE","TIME","INTERVAL","JSON","JSONB","UUID","BYTEA"],O=["count","sum","avg","min","max","array_agg","string_agg","json_agg","jsonb_agg","now","current_timestamp","current_date","age","date_trunc","date_part","extract","length","lower","upper","trim","ltrim","rtrim","substring","replace","concat","split_part","regexp_replace","regexp_matches","left","right","repeat","reverse","abs","ceil","floor","round","trunc","mod","power","sqrt","random","coalesce","nullif","greatest","least","row_number","rank","dense_rank","lag","lead","first_value","last_value","ntile","to_char","to_date","to_timestamp","to_number","json_build_object","jsonb_build_object","json_extract_path","jsonb_extract_path_text","array_length","unnest","generate_series","pg_size_pretty","pg_total_relation_size","pg_table_size","pg_indexes_size"];function x(i){const f=[],E=/\b(?:FROM|JOIN)\s+([a-zA-Z_][a-zA-Z0-9_]*(?:\.[a-zA-Z_][a-zA-Z0-9_]*)?)/gi;let u;for(;(u=E.exec(i))!==null;)f.push(u[1]);return f}function M(i){return{triggerCharacters:["."," "],provideCompletionItems(f,E){const u=f.getWordUntilPosition(E),c={startLineNumber:E.lineNumber,endLineNumber:E.lineNumber,startColumn:u.startColumn,endColumn:u.endColumn},a=[],C=I.getQueryData(["objects"]);for(const r of k)a.push({label:r,kind:i.languages.CompletionItemKind.Keyword,insertText:r,range:c,sortText:"3_"+r});for(const r of O)a.push({label:r,kind:i.languages.CompletionItemKind.Function,insertText:r+"($0)",insertTextRules:i.languages.CompletionItemInsertTextRule.InsertAsSnippet,range:c,sortText:"2_"+r});if(!C)return{suggestions:a};for(const[r,d]of Object.entries(C)){const p=[...d.tables,...d.views,...d.materialized_views];for(const l of p){const s=r==="public"?l.name:`${r}.${l.name}`;a.push({label:s,kind:i.languages.CompletionItemKind.Class,insertText:s,detail:l.type,range:c,sortText:"1_"+s})}for(const l of d.functions){const s=r==="public"?l.name:`${r}.${l.name}`;a.push({label:s,kind:i.languages.CompletionItemKind.Function,insertText:s+"($0)",insertTextRules:i.languages.CompletionItemInsertTextRule.InsertAsSnippet,range:c,sortText:"2_"+s})}}const R=f.getValue(),T=x(R);for(const r of T){const d=r.includes(".")?r:`public.${r}`,[p,l]=d.split("."),s=I.getQueryData(["table-columns",r])??I.getQueryData(["table-columns",`${p}.${l}`]);if(s)for(const e of s)a.push({label:e.name,kind:i.languages.CompletionItemKind.Field,insertText:e.name,detail:`${e.type} (${r})`,range:c,sortText:"0_"+e.name})}return{suggestions:a}}}}let N=!1,A=!1;const F=m.forwardRef(function({value:f,onChange:E,onRun:u,onExplain:c,onSave:a},C){const R=m.useRef(null);m.useImperativeHandle(C,()=>({getSelectedText:()=>{const e=R.current;if(!e)return;const t=e.getSelection(),n=e.getModel();if(t&&!t.isEmpty()&&n){const o=n.getValueInRange(t);return o.trim()?o:void 0}},formatSql:()=>{const e=R.current;if(!e)return;const t=e.getModel();if(!t)return;const n=t.getValue();if(n.trim())try{const o=S(n,{dialect:b,tabWidth:2,keywordCase:"upper"});t.setValue(o)}catch{}}}));const T=m.useRef(u),r=m.useRef(c),d=m.useRef(a);T.current=u,r.current=c,d.current=a;const p=m.useCallback((e,t)=>{R.current=e,A||(t.editor.defineTheme("pglet-light",{base:"vs",inherit:!0,rules:[{token:"keyword",foreground:"3d7568",fontStyle:"bold"},{token:"keyword.sql",foreground:"3d7568",fontStyle:"bold"},{token:"operator.sql",foreground:"4f9385"},{token:"predefined.sql",foreground:"4f9385"},{token:"string.sql",foreground:"b45309"},{token:"number",foreground:"c2410c"},{token:"comment",foreground:"a8a29e",fontStyle:"italic"}],colors:{"editor.selectionBackground":"#b1e0d4","editor.inactiveSelectionBackground":"#d6efe8","editor.selectionHighlightBackground":"#d6efe880","editorCursor.foreground":"#4f9385"}}),t.editor.defineTheme("pglet-dark",{base:"vs-dark",inherit:!0,rules:[{token:"keyword",foreground:"b1e0d4",fontStyle:"bold"},{token:"keyword.sql",foreground:"b1e0d4",fontStyle:"bold"},{token:"operator.sql",foreground:"92c5b9"},{token:"predefined.sql",foreground:"92c5b9"},{token:"string.sql",foreground:"fcd34d"},{token:"number",foreground:"fb923c"},{token:"comment",foreground:"78716c",fontStyle:"italic"}],colors:{"editor.selectionBackground":"#2f5b51","editor.inactiveSelectionBackground":"#2f5b5180","editor.selectionHighlightBackground":"#2f5b5160","editorCursor.foreground":"#b1e0d4"}}),A=!0),N||(t.languages.registerCompletionItemProvider("sql",M(t)),N=!0),e.addCommand(t.KeyMod.CtrlCmd|t.KeyCode.Enter,()=>{const n=e.getSelection(),o=e.getModel();if(n&&!n.isEmpty()&&o){const g=o.getValueInRange(n);if(g.trim()){T.current(g);return}}T.current()}),e.addCommand(t.KeyMod.CtrlCmd|t.KeyMod.Shift|t.KeyCode.Enter,()=>{const n=e.getSelection(),o=e.getModel();if(n&&!n.isEmpty()&&o){const g=o.getValueInRange(n);g.trim()&&T.current(g)}}),e.addAction({id:"explain-query",label:"Explain Query",keybindings:[t.KeyMod.CtrlCmd|t.KeyCode.KeyE],run:()=>r.current()}),e.addAction({id:"save-query",label:"Save Query",keybindings:[t.KeyMod.CtrlCmd|t.KeyCode.KeyS],run:()=>d.current?.()}),e.addAction({id:"format-sql",label:"Format SQL",keybindings:[t.KeyMod.Alt|t.KeyMod.Shift|t.KeyCode.KeyF],run:n=>{const o=n.getModel();if(!o)return;const g=o.getValue();if(g.trim())try{const _=S(g,{dialect:b,tabWidth:2,keywordCase:"upper"});o.setValue(_)}catch{}}}),e.focus()},[]),l=y(e=>e.theme),s=l==="dark"||l==="system"&&window.matchMedia("(prefers-color-scheme: dark)").matches;return h.jsx(L,{height:"100%",defaultLanguage:"sql",theme:s?"pglet-dark":"pglet-light",value:f,onChange:e=>E(e??""),onMount:p,options:{minimap:{enabled:!1},lineNumbers:"on",fontSize:13,fontFamily:"'IBM Plex Mono', 'JetBrains Mono', monospace",scrollBeyondLastLine:!1,wordWrap:"on",automaticLayout:!0,tabSize:2,padding:{top:8},quickSuggestions:!0,suggestOnTriggerCharacters:!0}})});export{F as SqlEditor};
